#!/bin/bash

BINDIR=$(cd $(dirname $0) && pwd)

. ${BINDIR}/common
. ${BINDIR}/functions

cd ${FPPDIR}

# Make sure a UUID file exists
${BINDIR}/get_uuid > /dev/null

logOutput

# Clear any restart flag
sed -i -e "s/^restartFlag .*/restartFlag = 0/" ${FPPHOME}/media/settings

if [ -f "/.dockerenv" ]
then
    echo "Setup channel outputs"
    setupChannelOutputs

    echo "Running pre-start scripts"
    runPreStartScripts

    echo "Starting ${FPPBINDIR}/fppd"
    nice -n -20 ${FPPBINDIR}/fppd --config-file ${FPPHOME}/media/settings --daemonize

    # FIXME, find a better way to wait until fppd is up before continuing
    sleep 2

    runPostStartScripts
else
    systemctl start fppd
fi

